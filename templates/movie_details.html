<!-- movie_details.html -->
{% extends 'masterPage.html' %}

{% block head %}
<title>{{ movie.title }} - Details</title>
<style>
body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background-color: #141414;
    color: #e5e5e5;
    margin: 0;
    padding: 20px;
}

h1, h2 {
    color: #ffffff;
}

img {
    border-radius: 8px;
}

p {
    font-size: 16px;
    line-height: 1.5;
}

form {
    margin-top: 20px;
    background-color: #333333;
    padding: 20px;
    border-radius: 8px;
}

label {
    display: block;
    margin-bottom: 10px;
    color: #b3b3b3;
}

input[type="number"],
textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    border: none;
    border-radius: 4px;
    background-color: #444444;
    color: #ffffff;
}

button {
    background-color: #e50914;
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}

button:hover {
    background-color: #f40612;
}

a {
    color: #e50914;
}

a:hover {
    text-decoration: underline;
}

div.review {
    background-color: #222222;
    padding: 20px;
    margin-top: 20px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
}

div.review img {
    border-radius: 50%;
    margin-right: 20px;
}

div.review-content {
    flex-grow: 1;
}

div.review-content strong {
    font-size: 18px;
}

div.review-content p {
    margin: 10px 0;
}

div.review-actions {
    display: flex;
    gap: 10px;
}

form[id^="upvote-form-"],
form[id^="downvote-form-"] {
    display: inline;
}

button[id^="upvote-button-"],
button[id^="downvote-button-"] {
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 16px;
}

button[id^="upvote-button-"]:hover,
button[id^="downvote-button-"]:hover {
    text-decoration: underline;
}

</style>
{% endblock %}

{% block body %}
<!-- Movie Details -->
<h1>{{ movie.title }}</h1>
<img src="https://image.tmdb.org/t/p/w500/{{ movie.backdrop_path }}" alt="{{ movie.title }}" style="width:100%; max-height:300px; object-fit:cover;">
<p>{{ movie.overview }}</p>
<p>Rating: {{ movie.vote_average }} / 10</p>
<p>Genres: {{ movie.genres | join(', ') }}</p>
<p>Release Date: {{ movie.release_date }}</p>

<!-- User's Review Form -->
{% if 'username' in session %}
    <form action="{{ url_for('add_review', movie_id=movie.id) }}" method="POST">
        <label for="rating">Your Rating:</label>
        <input type="number" name="rating" id="rating" min="1" max="10" value="5" required>

        <label for="review_text">Your Review:</label>
        <textarea name="review_text" id="review_text" rows="4" required></textarea>

        <button type="submit">Submit Review</button>
    </form>
{% else %}
    <p>You need to be <a href="{{ url_for('auth.login') }}">logged in</a> to add a review.</p>
{% endif %}

<!-- Display Existing Reviews -->
<h2>Reviews:</h2>
{% for review in reviews %}
    <div>
        <p><strong>{{ review[5] }}</strong> rated this movie {{ review[1] }} / 10</p>
        <p>{{ review[2] }}</p>
        <p>Upvotes: {{ review[3] }} | Downvotes: {{ review[4] }}</p>

        {% if 'username' in session %}
            <!-- Upvote Button -->
            <form id="upvote-form-{{ review[0] }}" action="{{ url_for('upvote_review', movie_id=movie.id, review_id=review[0]) }}" method="POST" style="display:inline;">
                <button type="submit" id="upvote-button-{{ review[0] }}" style="color: {% if review[6] == 'upvote' %}blue{% else %}black{% endif %};">
                    Upvote
                </button>
            </form>

            <!-- Downvote Button -->
            <form id="downvote-form-{{ review[0] }}" action="{{ url_for('downvote_review', movie_id=movie.id, review_id=review[0]) }}" method="POST" style="display:inline;">
                <button type="submit" id="downvote-button-{{ review[0] }}" style="color: {% if review[6] == 'downvote' %}blue{% else %}black{% endif %};">
                    Downvote
                </button>
            </form>

            <script>
                document.getElementById('upvote-form-{{ review[0] }}').addEventListener('submit', function(event) {
                    event.preventDefault();
                    let button = document.getElementById('upvote-button-{{ review[0] }}');
                    let currentColor = button.style.color;

                    if (currentColor === 'black') {
                        button.style.color = 'blue';
                        this.submit();
                    } else {
                        button.style.color = 'black';
                        // Send a request to undo the upvote
                        window.location.href = "{{ url_for('undo_upvote_review', movie_id=movie.id, review_id=review[0]) }}";
                    }
                });

                document.getElementById('downvote-form-{{ review[0] }}').addEventListener('submit', function(event) {
                    event.preventDefault();
                    let button = document.getElementById('downvote-button-{{ review[0] }}');
                    let currentColor = button.style.color;

                    if (currentColor === 'black') {
                        button.style.color = 'blue';
                        this.submit();
                    } else {
                        button.style.color = 'black';
                        // Send a request to undo the downvote
                        window.location.href = "{{ url_for('undo_downvote_review', movie_id=movie.id, review_id=review[0]) }}";
                    }
                });
            </script>
        {% endif %}
    </div>
{% endfor %}

{% endblock %}

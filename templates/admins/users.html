{% extends "admins/sidebar.html" %}

{% block title %}
    Users - Admin Dashboard
{% endblock %}

{% block content %}
<link rel="stylesheet" href="/static/admin.css">

    <h1>Users</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div>
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <!-- Search and All Users Form -->
    <form id="searchForm" action="{{ url_for('admin.admin_users') }}" method="get">
        <input type="text" name="search" placeholder="Search users..." value="{{ request.args.get('search', '') }}">
        <button type="submit">Search</button>
        <button type="button" onclick="showAllUsers()">All</button>
        <select name="per_page" onchange="this.form.submit()">
            <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
            <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
        </select>
    </form>

    <!-- Table of Users -->
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user['username'] }}</td>
                <td>{{ user['email'] }}</td>
                <td>
                    <form action="{{ url_for('admin.toggle_admin', user_id=user['id']) }}" method="post" style="display:inline;">
                        <button type="submit">
                            {% if user['is_admin'] %}
                            Unmake Admin
                            {% else %}
                            Make Admin
                            {% endif %}
                        </button>
                    </form>
                    <form action="{{ url_for('admin.delete_user', user_id=user['id']) }}" method="post" style="display:inline;">
                        <button type="submit">Delete User</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div style="display: flex; justify-content: center;">
        <ul>
            {% if page > 1 %}
                <li><a href="{{ url_for('admin.admin_users', search=search_query, per_page=per_page, page=page-1) }}">Previous</a></li>
            {% endif %}
            {% for p in range(1, total_pages + 1) %}
                <li><a href="{{ url_for('admin.admin_users', search=search_query, per_page=per_page, page=p) }}">{{ p }}</a></li>
            {% endfor %}
            {% if page < total_pages %}
                <li><a href="{{ url_for('admin.admin_users', search=search_query, per_page=per_page, page=page+1) }}">Next</a></li>
            {% endif %}
        </ul>
    </div>

    <script>
        function showAllUsers() {
            window.location.href = "{{ url_for('admin.admin_users') }}";
        }
    </script>
{% endblock %}
